(() => {
  // assets/js/main.js
  var modal;
  var modalSwiper;
  var more;
  var loading;
  var medias;
  var pending;
  var ids = [];
  var goTop = document.querySelector(".go-top");
  var scrollTop = 0;
  var lazyed;
  document.addEventListener("scroll", throttle(function() {
    scrollTop = document.documentElement.scrollTop;
    if (scrollTop > 1e3) {
      goTop.style.opacity = 1;
    } else {
      goTop.style.opacity = 0;
    }
    if (more) {
      var display = more.style.display;
      if (display !== "none") {
        var offset = more.offsetTop - document.documentElement.scrollTop - window.innerHeight;
        if (offset < 300) {
          more.click();
        }
      }
    }
    if (!lazyed) {
      lazyed = true;
      var lazyImages = [].slice.call(document.querySelectorAll("img.lazy"));
      if ("IntersectionObserver" in window) {
        let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              let lazyImage = entry.target;
              lazyImage.src = lazyImage.dataset.src;
              lazyImage.classList.remove("lazy");
              lazyImageObserver.unobserve(lazyImage);
            }
          });
        });
        lazyImages.forEach(function(lazyImage) {
          lazyImageObserver.observe(lazyImage);
        });
      } else {
        lazyImages.forEach(function(lazyImage) {
          lazyImage.src = lazyImage.dataset.src;
        });
      }
    }
  }, 200));
  goTop.addEventListener("click", function() {
    var timer = setInterval(function() {
      if (scrollTop > 2e3) {
        scrollTop -= scrollTop / 50;
      } else {
        scrollTop -= 30;
      }
      if (scrollTop < 0) {
        clearInterval(timer);
        scrollTop = 0;
      }
      window.scroll(0, scrollTop);
    }, 1);
  });
  var search = document.querySelector(".search-wrapper");
  if (search) {
    imgs = [].slice.call(document.querySelectorAll("img"));
    for (i = 0; i < imgs.length; i++) {
      imgs[i].addEventListener("error", function(e) {
        e.target.src = "/img/default.jpg";
      });
    }
  }
  var imgs;
  var i;
  more = document.querySelector(".more-posts");
  if (more) {
    loading = document.querySelector(".lds-hourglass");
    more.addEventListener("click", function(e) {
      var node = e.target;
      node.style.display = "none";
      loading.style.display = "block";
      var type = node.dataset.type;
      var api = "/api/posts/?id=" + node.dataset.id + "&cursor=" + node.dataset.cursor + "&type=" + type;
      fetch(api).then(function(res) {
        if (res.ok)
          return res.json();
        throw Error("fail");
      }).then(function(json) {
        loading.style.display = "none";
        if (json.hasNext) {
          node.dataset.cursor = json.cursor;
          more.style.display = "block";
        } else {
          document.querySelector(".end").style.display = "block";
        }
        if (json.items) {
          var tpl = "";
          json.items.forEach(function(item) {
            var icon = "";
            if (item.isVideo) {
              icon = '<svg fill="#ffffff" height="18" viewBox="0 0 48 48" width="18"><path d="M26.1 0L33 11.52H19.6L13.6.1a13.42 13.42 0 012.1-.1h10.4zM9.9.7l5.8 10.82H.4A13.09 13.09 0 014.1 4 12 12 0 019.9.7zM30.1 0h1.6c6 0 9.3 1.2 12.2 4.11a12.51 12.51 0 013.7 7.41H37zm1.7 29.06l-11.2-6.51A1.72 1.72 0 0018 24v13.08a1.79 1.79 0 002.5 1.6l.1-.1 11.2-6.51a1.7 1.7 0 00.1-2.91l-.1-.1-11.2-6.51zM0 15h48v16.77c0 6-1.2 9.32-4.1 12.22-2.8 2.71-6 4-11.7 4h-16c-6 0-9.3-1.2-12.2-4.11-2.7-2.8-4-6-4-11.72V15z"></path></svg>';
            }
            if (item.isSidecar) {
              icon = '<svg fill="#ffffff" height="22" viewBox="0 0 48 48" width="22"><path d="M34.8 29.7V11c0-2.9-2.3-5.2-5.2-5.2H11c-2.9 0-5.2 2.3-5.2 5.2v18.7c0 2.9 2.3 5.2 5.2 5.2h18.7c2.8-.1 5.1-2.4 5.1-5.2zM39.2 15v16.1c0 4.5-3.7 8.2-8.2 8.2H14.9c-.6 0-.9.7-.5 1.1 1 1.1 2.4 1.8 4.1 1.8h13.4c5.7 0 10.3-4.6 10.3-10.3V18.5c0-1.6-.7-3.1-1.8-4.1-.5-.4-1.2 0-1.2.6z"></path></svg>';
            }
            tpl += '<a href="/p/' + item.code + '/" class="item"><div class="img">' + icon + '<img src="' + item.thumb + '"/></div></a>';
          });
          if (tpl) {
            var postItems = document.querySelector(".post-items");
            postItems.insertAdjacentHTML("beforeend", tpl);
            addAd(postItems);
          }
        }
      }).catch(function(err) {
        console.log(err);
        more.style.display = "block";
        loading.style.display = "none";
        showError("Request failed, try again later");
      });
    });
  }
  var user = document.querySelector(".user-wrapper");
  if (user) {
    modal = document.querySelector(".modal");
    modal.addEventListener("click", function(e) {
      var tag = e.target.parentNode;
      if (tag && tag.classList.contains("video-wrap")) {
        window.open(tag.dataset.video, "_blank");
      }
    });
    modal.querySelector(".close").addEventListener("click", function() {
      document.body.classList.remove("no-scroll");
      modal.style.display = "none";
      if (modalSwiper)
        modalSwiper.destroy(true, true);
      modal.querySelector(".swiper-wrapper").innerHTML = "";
    });
    uid = user.dataset.id;
    ua = navigator.userAgent;
    api = "/api/reels/?id=" + uid;
    if (!ua.includes("bot.htm")) {
      fetch(api).then(function(res) {
        if (res.ok) {
          return res.json();
        }
        throw new Error("fail");
      }).then(function(json) {
        var style = document.createElement("link");
        var script = document.createElement("script");
        style.setAttribute("rel", "stylesheet");
        style.setAttribute("href", "https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.5.8/swiper-bundle.min.css");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/Swiper/6.5.8/swiper-bundle.min.js";
        document.head.appendChild(style);
        document.head.appendChild(script);
        if (json.hasStory) {
          user.querySelector(".avatar").classList.add("story-bg");
          ids.push(uid);
        }
        var tpl = "";
        json.reels.forEach(function(reel) {
          ids.push(reel.id);
          tpl += '<div class="swiper-slide" data-id="' + reel.id + '"><img class="lazy" src="/img/lazy.jpg" data-src="' + reel.img + '" alt="' + reel.title + '"/><div class="title">' + reel.title + "</div></div>";
        });
        if (tpl) {
          script.onload = function() {
            document.querySelector(".swiper-wrapper").innerHTML = tpl;
            new Swiper(".reels", {
              slidesPerView: "auto",
              loopedSlides: 2
            });
          };
        }
      }).catch(function() {
      });
    }
    storyBg = user.querySelector(".avatar");
    storyBg.addEventListener("click", function() {
      if (storyBg.classList.contains("story-bg")) {
        fetchMedia(user.dataset.id);
      }
    });
    document.querySelector(".reels").addEventListener("click", function(e) {
      var node = e.target.parentNode;
      if (node && node.classList.contains("swiper-slide")) {
        var id = node.dataset.id;
        fetchMedia(id);
      }
    });
  }
  var uid;
  var ua;
  var api;
  var storyBg;
  function fetchMedia(id) {
    if (!ids.length)
      return;
    if (pending)
      return;
    var api = "/api/medias/?ids=" + ids.join(",");
    if (medias) {
      renderMedia(medias[id]);
    } else {
      pending = true;
      fetch(api).then(function(res) {
        if (!res.ok)
          throw Error("request fail");
        return res.json();
      }).then(function(json) {
        pending = false;
        medias = json;
        renderMedia(medias[id]);
      }).catch(function() {
        pending = false;
        showError("Request failed, try again later");
      });
    }
  }
  function renderMedia(items) {
    var tpl = "";
    items.forEach(function(item) {
      var media = '<img src="' + item.thumb + '"/>';
      if (item.src.includes(".mp4")) {
        media = '<div data-video="' + item.src + '" class="video-wrap"><img class="play" src="/img/play.png"><img src="' + item.thumb + '"></div>';
      }
      tpl += '<div class="swiper-slide">' + media + "</div>";
    });
    var srcs = items.map(function(item) {
      return item.src;
    });
    showModal(tpl.trim(), items.length !== 1, srcs);
  }
  function showModal(tpl, isSwiper, srcs) {
    var download = modal.querySelector(".download");
    modal.classList.add("no-swiper");
    modal.querySelector(".swiper-wrapper").innerHTML = tpl;
    var src = srcs[0];
    download.setAttribute("href", src + "&dl=1");
    modal.style.display = "block";
    document.body.classList.add("no-scroll");
    if (isSwiper) {
      modal.classList.remove("no-swiper");
      modalSwiper = new Swiper(".media", {
        slidesPerView: "auto",
        navigation: {
          nextEl: ".swiper-button-next",
          prevEl: ".swiper-button-prev"
        },
        pagination: {
          el: ".swiper-pagination",
          type: "bullets"
        }
      });
      modalSwiper.on("slideChange", function() {
        var index = modalSwiper.activeIndex;
        var src2 = srcs[index];
        download.setAttribute("href", src2 + "&dl=1");
      });
    }
  }
  function showError(msg) {
    var el = document.querySelector(".error");
    if (!el) {
      el = document.createElement("div");
      el.className = "error";
      document.body.appendChild(el);
    }
    el.innerText = msg;
    el.style.opacity = 0.9;
    setTimeout(function() {
      el.style.opacity = 0;
    }, 2e3);
  }
  function throttle(fn, gapTime) {
    var _lastTime = null;
    return function() {
      var _nowTime = +new Date();
      if (_nowTime - _lastTime > gapTime || !_lastTime) {
        fn();
        _lastTime = _nowTime;
      }
    };
  }
  console.log("hhhhh");
  function addAd(el) {
    let adTag;
    if (document.body.dataset.media === "1") {
      setTimeout(function() {
        window.demandSupply && window.demandSupply.surge && window.demandSupply.surge.displayAd("imginn.org_fluid_sq_new");
      }, 30);
      adTag = `<div class="media-wrap">
      <div data-ad="imginn.org_fluid_sq_new" data-devices="m:1,t:1,d:1" style="min-height: 296px;" class="demand-supply"></div>
    </div>`;
    } else {
      adTag = `<div class="media-wrap">
    <h12 class="h12container" data-pub="64e985fb18d9f717e102af55b048ecc6" data-adunit="23982" data-type="responsive" data-format="standard" data-init="false"></h12>
    </div>`;
    }
    el.insertAdjacentHTML("beforeend", adTag);
  }
})();
